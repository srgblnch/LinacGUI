image: pc218:5000/debpack

variables:
  PKG_REPO: 'linacgui_deb'
  PKG_REPO_URL: 'https://git.cells.es/ctpkg/$PKG_REPO'

# Defines stages which are to be executed
stages:  
  - build
  - test
  - deploy


debug:  
  stage: build
  script:
    - mkdir artifacts
    - cd /packaging
    - git clone $PKG_REPO_URL 
    - cd $PKG_REPO
    - git checkout upstream && git checkout pristine-tar && git checkout master
    - echo $GITLAB_USER_EMAIL
    - git show 2.72.14 |grep Tagger|cut -d\  -f3

    
# Stage "build"
run-build:  
  stage: build
  script:
    - mkdir artifacts
    - cd /packaging
    - git clone $PKG_REPO_URL 
    - cd $PKG_REPO
    - git checkout upstream && git checkout pristine-tar && git checkout master
    - gbp import-orig --uscan --merge-mode=replace --pristine-tar --no-interactive --postimport='gbp dch -N$GBP_UPSTREAM_VERSION-0~bpo9+0~alba+1 -R -c --debian-branch=$GBP_BRANCH --spawn-editor=never '
    - cat debian/changelog
    - cowbuilder --update
    - gbp buildpackage --git-export-dir=$CI_PROJECT_DIR/artifacts/ --git-postbuild='echo gbp buildpackage finished' # do not run checks now
    # list the artifacts dir
    - ls -la $CI_PROJECT_DIR/artifacts/

  # This stage is only executed for new tags
  only:
    - tags

  # The files which are to be made available in GitLab
  artifacts:
    paths:
      - artifacts/*

lintian: 
  stage: test
  script:
    - lintian -i -I --suppress-tags backports-upload-has-incorrect-version-number,backports-changes-missing artifacts/*.changes
  allow_failure: true
  only:
    - tags
    
piuparts: 
  stage: test
  script:
    - piuparts -d stretch -m http://httpredir.debian.org/debian --extra-repo 'deb [ trusted=yes ] http://controls01.cells.es/testrepo debian9/' artifacts/*.changes
  allow_failure: true
  only:
    - tags
    
deploy_to_staging:
  stage: deploy
  script:
    - echo 'TODO this would call dput to the staging repo with appropriate credentials'
    - ls artifacts/*
  only:
    - tags
    
deploy_to_production:
  stage: deploy
  script:
    - echo 'TODO This would call dput to the production repo with appropriate credentials'
    - echo 'TODO This would push the local git repo to $PKG_REPO_URL'
  when: manual
  only:
    - tags